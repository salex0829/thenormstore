<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THE NORM STORE â€“ Product Selector</title>
  <style>
    :root{
      --thumb-ratio: 4/3;
      --bg1:#0d1b2a; --bg2:#10243a; --bg3:#1a324d;
      --glass:#ffffffcc; --stroke:#2a3e55; --ink:#e7f2ff; --muted:#aac6de;
      --shadow: 0 10px 30px rgba(0,0,0,.25), 0 2px 8px rgba(0,0,0,.2);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(1200px 700px at 80% -10%, #0b172a 0%, transparent 60%),
        radial-gradient(1800px 900px at -10% 10%, var(--bg2) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg3));
      animation: skyShift 18s ease-in-out infinite;
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    @keyframes skyShift { 0%{background-position:0 0,0 0,0 0} 50%{background-position:0 -7%,-5% 4%,0 0} 100%{background-position:0 0,0 0,0 0} }

    .bubbles{position:fixed; inset:0; pointer-events:none; z-index:1}
    .bubbles i{position:absolute; border-radius:999px; background:linear-gradient(180deg,#cfe7ff,rgba(255,255,255,.6)); box-shadow:0 10px 30px rgba(0,163,255,.18)}
    .b1{width:180px; height:180px; left:6%; top:14%; filter:blur(2px); opacity:.4}
    .b2{width:260px; height:260px; right:8%; top:8%; opacity:.35}
    .b3{width:120px; height:120px; left:18%; bottom:10%; opacity:.38}
    @keyframes float1 { 0%{transform:translateY(0) rotate(0);opacity:.35} 50%{transform:translateY(-38px) rotate(10deg);opacity:.7} 100%{transform:translateY(0) rotate(0);opacity:.35} }
    @keyframes float2 { 0%{transform:translate(0,0) rotate(0);opacity:.45} 50%{transform:translate(16px,-42px) rotate(-12deg);opacity:.8} 100%{transform:translate(0,0) rotate(0);opacity:.45} }
    .bubbles i{animation:float1 6s ease-in-out infinite; will-change:transform,opacity}
    .bubbles .b2{animation:float2 8s ease-in-out infinite}
    .bubbles .b3{animation:float1 7s ease-in-out -2s infinite}

    header{
      position:sticky; top:0; z-index:3; backdrop-filter:saturate(1.4) blur(8px);
      background:linear-gradient(180deg,rgba(22,34,52,.7),rgba(22,34,52,.35));
      border-bottom:1px solid var(--stroke);
    }
    .hdr{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:12px}
    .brand .mark{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,#00d1ff,#00a3ff); box-shadow:var(--shadow)}
    .brand .title{font-weight:800; letter-spacing:.02em}
    .toolbar{display:flex; gap:8px}
    .btn{border:1px solid var(--stroke); background:linear-gradient(180deg,#1c2a3b,#233549); color:#e7f2ff;
      padding:10px 14px; border-radius:999px; cursor:pointer; box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(180deg,#0e2e44,#134766); border-color:#2a5a7a}
    .btn-danger{background:linear-gradient(180deg,#3a1220,#52182a); border-color:#6a1f38; color:#ffd8e1}

    main{padding:18px; position:relative; z-index:2}
    .panel{position:relative; background:linear-gradient(180deg,rgba(20,30,46,.8),rgba(20,30,46,.65)); border:1px solid var(--stroke); border-radius:24px; padding:16px; box-shadow:var(--shadow)}
    .panel h2{margin:0 0 10px; font-size:14px; letter-spacing:.08em; color:#bde0ff}
    .hint{color:var(--muted); margin:-2px 0 12px}

    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px}
    .card{
      display:flex; flex-direction:column;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
      border-radius:20px; overflow:hidden; cursor:pointer; transition:.2s transform,.2s box-shadow;
      min-height:240px;
    }
    .card:hover{transform:translateY(-2px); box-shadow:var(--shadow)}

    .thumb{position:relative; width:100%; aspect-ratio:var(--thumb-ratio); background:linear-gradient(135deg,#102c45,#0f2236); overflow:hidden}
    .thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; display:block; -webkit-user-drag:none; user-select:none; image-rendering:auto}

    .body{padding:12px 14px; display:flex; flex-direction:column; gap:6px}
    .name{font-weight:800; font-size:14px; line-height:1.3; word-break:break-all}
    .meta{display:flex; gap:8px; align-items:center; color:#a9c9e4; font-size:12px}
    .chip{border:1px solid var(--stroke); padding:4px 10px; border-radius:999px; background:linear-gradient(180deg,#142033,#102136)}

    .modal{
      position:fixed; inset:0; display:none; place-items:center;
      background:linear-gradient(180deg,rgba(9,18,30,.6),rgba(9,18,30,.25));
      backdrop-filter:blur(8px); z-index:4
    }
    .modal.active{display:grid}
    .dialog{
      width:min(780px,94vw); border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0f2034ee,#0c1a2cee);
      border-radius:28px; box-shadow:var(--shadow); overflow:hidden;
      display:flex; flex-direction:column; color:#e7f2ff;
    }
    .head{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; border-bottom:1px solid var(--stroke)}
    .head .title{font-weight:900; letter-spacing:.02em}

    .viewer{
      position:relative; flex:1 1 auto; display:flex; justify-content:center; align-items:center;
      background:linear-gradient(180deg,#0d2136,#0b1a2b);
      padding:20px 24px; max-height:60vh; overflow:hidden;
    }
    .viewer img{
      width:100%; height:auto; max-width:100%; max-height:100%;
      object-fit:contain; object-position:center; display:block;
      border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,.35);
      background:#0a1a29;
    }

    .info{padding:16px 20px; border-top:1px solid var(--stroke)}
    #modalProduct{font-size:16px; margin-bottom:6px; line-height:1.5; word-break:break-all}
    .actions{display:flex; gap:10px; justify-content:flex-end; padding:14px 16px; border-top:1px solid var(--stroke)}
    .btn-yes{background:linear-gradient(180deg,#0f3a2a,#135b41); border-color:#1f7c5a; color:#d6ffe9}
    .btn-no{background:linear-gradient(180deg,#3a1520,#5a1d2c); border-color:#7a2a3c; color:#ffd6de}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:20px;
      background:linear-gradient(180deg,#0e2136,#0c1a2c);
      border:1px solid var(--stroke); color:#e7f2ff; padding:10px 12px;
      border-radius:12px; display:none; box-shadow:var(--shadow); z-index:5
    }
    .toast.show{display:block}

    .celebrate{position:fixed; inset:0; pointer-events:none; z-index:6}
    .celebrate .okring{
      position:absolute; left:50%; top:40%; width:140px; height:140px;
      border:4px solid #4ce078; border-radius:999px;
      transform:translate(-50%,-50%) scale(.6); opacity:0; animation:ringPop .8s ease-out forwards;
    }
    @keyframes ringPop{
      0%{transform:translate(-50%,-50%) scale(.6); opacity:.3}
      70%{transform:translate(-50%,-50%) scale(1.2); opacity:.15}
      100%{transform:translate(-50%,-50%) scale(1.45); opacity:0}
    }
    .celebrate .ok{
      position:absolute; left:50%; top:40%;
      transform:translate(-50%,-50%) scale(.86);
      background:rgba(10,26,41,.92); border:1px solid var(--stroke); border-radius:16px;
      padding:10px 14px; display:flex; gap:10px; align-items:center; box-shadow:var(--shadow);
      animation:okPop .6s ease-out forwards; font-weight:800; color:#dffaf9;
    }
    .celebrate .ok svg{width:24px; height:24px}
    @keyframes okPop{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.7)}
      60%{opacity:1; transform:translate(-50%,-50%) scale(1.04)}
      100%{opacity:1; transform:translate(-50%,-50%) scale(1)}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
</head>
<body>
  <canvas id="bgSparkle" style="position:fixed; inset:0; z-index:0; pointer-events:none;"></canvas>
  <div class="bubbles"><i class="b1"></i><i class="b2"></i><i class="b3"></i></div>

  <header>
    <div class="hdr">
      <div class="brand"><div class="mark"></div><div class="title">THE NORM STORE â€“ Product Selector</div></div>
      <div class="toolbar">
        <a class="btn btn-primary" id="open-viz" href="viz.html" target="_blank">ğŸ“º å¯è¦–åŒ–ã‚’é–‹ã</a>
        <button id="btn-reset" class="btn btn-danger" title="ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã ã‘å‰Šé™¤">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å…¨æ¶ˆå»</button>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>CATALOG</h2>
      <p class="hint">è£½å“ç”»åƒã‚’ã‚¿ãƒƒãƒ— â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèª â†’ å‡ºè·åˆ¤æ–­ï¼ˆYES / NOï¼‰</p>
      <div id="grid" class="grid"></div>
    </section>
  </main>

  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="head">
        <div id="modalTitle" class="title">å‡ºè·ç¢ºèª</div>
        <button id="btn-close" class="btn">é–‰ã˜ã‚‹</button>
      </div>
      <div class="viewer"><img id="viewerImg" alt=""></div>
      <div class="info">
        <div id="modalProduct">ã€Œâ—¯â—¯ã€ã‚’æœªæ¥ç¤¾ä¼šã¸å‡ºè·ã—ã¾ã™ã‹ï¼Ÿ</div>
      </div>
      <div class="actions">
        <button id="answer-no" class="btn btn-no">NO / ä¿ç•™</button>
        <button id="answer-yes" class="btn btn-yes">YES / å‡ºè·</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">é€ä¿¡ã—ã¾ã—ãŸ</div>

  <script>
    /* ==== å…±æœ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆURLæŒ‡å®šå¯ï¼‰ ==== */
    const DEFAULT_SESSION_ID = "20251016_shibuya_a";
    const urlSession = new URL(location.href).searchParams.get('session');
    const SESSION_ID = (urlSession && urlSession.trim()) || DEFAULT_SESSION_ID;

    // ã€Œå¯è¦–åŒ–ã‚’é–‹ãã€ãƒªãƒ³ã‚¯ã«ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å—ã‘æ¸¡ã—
    const vizLink = document.getElementById('open-viz');
    if (vizLink) vizLink.href = `viz.html?session=${encodeURIComponent(SESSION_ID)}`;

    /* ==== è¨­å®šï¼šç”»åƒãƒ‘ã‚¹ã®å„ªå…ˆé † ==== */
    const PATH = {
      THUMB_1: 'img/thumb/',
      THUMB_2: 'img/',
      LARGE_1: 'img/large/',
      LARGE_2: 'img/',
    };

    /* ==== Firebase ==== */
    const firebaseConfig = { apiKey: "AIzaSyCDdz7o8PoUdr28-8TZhEk33SP14aWuIzs", authDomain: "thenorm-5caf7.firebaseapp.com", projectId: "thenorm-5caf7" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const votesRef = db.collection('votes');

    /* ==== ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒªã‚¹ãƒˆï¼ˆè¡¨ç¤ºåï¼ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰ ==== */
    const FILES = [
      'Rebel Fashion Symbolâ€‹',
      'BioGlow Wear',
      'Dream Mode Shoes',
      'Echo Void Boot',
      'Ascent Robe',
      'GenFood',
      'Healthy Fit Fast',
      'Neutri',
      'Oyakome',
      'LEGENDS LIVE 2.0',
      'C-Suite Kindergarten',
      'MIRAI',
      'BareSync',
      'Onomatopedia',
    ];

    function stem(file){ return (file||'').replace(/^.*\//,''); }
    function placeholderSVG(text){
      const label = (text || '').slice(0,16);
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
            <stop stop-color="#102c45" offset="0"/><stop stop-color="#0f2236" offset="1"/>
          </linearGradient></defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="52%" font-family="system-ui,Segoe UI,Roboto,Noto Sans JP,sans-serif"
                font-size="48" font-weight="700" fill="#cde7ff" text-anchor="middle">${label}</text>
        </svg>`;
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    function setImgWithFallback(imgEl, urls){
      imgEl.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="40" height="30"><rect width="100%" height="100%" fill="#0e2338"/></svg>');
      let i = 0;
      function tryNext(){
        if(i >= urls.length){ imgEl.src = placeholderSVG('NO IMAGE'); return; }
        const url = urls[i++];
        const test = new Image();
        test.onload  = ()=>{ imgEl.src = url; };
        test.onerror = tryNext;
        test.src = url;
      }
      tryNext();
    }

    const PRODUCTS = FILES.map(file => {
      const filename = stem(file);
      return { id: filename, file: filename, name: filename };
    });

    const $grid = document.getElementById('grid');
    function renderGrid(){
      $grid.innerHTML = PRODUCTS.map(p=>{
        const title = p.name;
        return `
          <article class="card" data-id="${p.id}">
            <div class="thumb">
              <img data-id="${p.id}" data-name="${title}" alt="${title}">
            </div>
            <div class="body">
              <div class="name">${title}</div>
            </div>
          </article>`;
      }).join('');

      $grid.querySelectorAll('.thumb img').forEach(img=>{
        const id = img.getAttribute('data-id');
        const p = PRODUCTS.find(x=>x.id===id);
        const urls = [ PATH.THUMB_1 + p.file, PATH.THUMB_2 + p.file ];
        setImgWithFallback(img, urls);
      });

      $grid.querySelectorAll('.card').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          openModal(PRODUCTS.find(x=>x.id===id));
        });
      });
    }

    const $modal = document.getElementById('modal');
    const $modalTitle = document.getElementById('modalTitle');
    const $modalProduct = document.getElementById('modalProduct');
    const $viewerImg = document.getElementById('viewerImg');

    function openModal(p){
      const title = p.name;
      $modalTitle.textContent = 'å‡ºè·ç¢ºèª';
      $modalProduct.textContent = `ã€Œ${title}ã€ã‚’æœªæ¥ç¤¾ä¼šã¸å‡ºè·ã—ã¾ã™ã‹ï¼Ÿ`;

      const exts = [
        p.file,
        p.file.replace(/\.[^.]+$/, '.png'),
        p.file.replace(/\.[^.]+$/, '.PNG'),
        p.file.replace(/\.[^.]+$/, '.jpg'),
        p.file.replace(/\.[^.]+$/, '.JPG'),
        p.file.replace(/\.[^.]+$/, '.jpeg'),
        p.file.replace(/\.[^.]+$/, '.JPEG'),
      ];

      const candidates = [
        ...exts.map(x => PATH.LARGE_1 + x),
        ...exts.map(x => PATH.LARGE_2 + x),
        ...exts.map(x => PATH.THUMB_1 + x),
        ...exts.map(x => PATH.THUMB_2 + x),
      ];

      setImgWithFallback($viewerImg, candidates);
      $modal.classList.add('active');
      window.__current = p;
    }

    function closeModal(){ $modal.classList.remove('active'); window.__current=null; }
    document.getElementById('btn-close').addEventListener('click', closeModal);
    $modal.addEventListener('click', e=>{ if(e.target === $modal) closeModal(); });

    function celebrateYes(){
      const layer = document.createElement('div');
      layer.className = 'celebrate';
      layer.innerHTML = `
        <div class="okring"></div>
        <div class="ok">
          <svg viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          YES ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ
        </div>`;
      document.body.appendChild(layer);
      setTimeout(()=> layer.remove(), 900);
    }

    document.getElementById('answer-yes').addEventListener('click', ()=> handle('yes'));
    document.getElementById('answer-no').addEventListener('click', ()=> handle('no'));

    async function handle(answer){
      if(!window.__current) return;
      try{
        await votesRef.add({
          productId: window.__current.id,
          fileName: window.__current.file,
          answer,
          session: SESSION_ID, // â˜… viz ã¨åŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§æ›¸ãè¾¼ã‚€
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        if (answer === 'yes') celebrateYes();
        toast('é€ä¿¡ã—ã¾ã—ãŸ');
      }catch(e){
        toast('é€ä¿¡ã‚¨ãƒ©ãƒ¼: '+ e.message);
      }
      closeModal();
    }

    // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿å‰Šé™¤
    document.getElementById('btn-reset').addEventListener('click', async ()=>{
      if(!confirm(`session="${SESSION_ID}" ã® votes ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
      const snap = await votesRef.where('session','==',SESSION_ID).get();
      const batch = db.batch();
      snap.forEach(doc=> batch.delete(doc.ref));
      await batch.commit();
      toast('å‰Šé™¤ã—ã¾ã—ãŸ');
    });

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),1200);
    }

    (function sparkle(){
      const c = document.getElementById('bgSparkle'); if(!c) return;
      const ctx = c.getContext('2d', { alpha: true });
      let w, h, dpr = Math.min(2, window.devicePixelRatio || 1);
      const N = 100;
      const ps = [];

      function resize(){
        w = c.clientWidth; h = c.clientHeight;
        c.width = Math.floor(w * dpr);
        c.height = Math.floor(h * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      new ResizeObserver(resize).observe(document.body);
      resize();

      function init(){
        ps.length = 0;
        for(let i=0;i<N;i++){
          ps.push({ x: Math.random()*w, y: Math.random()*h, r: 0.8 + Math.random()*1.6, a: 0.25 + Math.random()*0.25,
                    vx: (-0.2 + Math.random()*0.9), vy: (-0.2 + Math.random()*0.9) });
        }
      }
      init();

      function tick(){
        ctx.clearRect(0,0,w,h);
        const grd = ctx.createRadialGradient(w*0.7,h*0.2,0, w*0.7,h*0.2, Math.max(w,h)*0.8);
        grd.addColorStop(0,'rgba(255,255,255,0.06)');
        grd.addColorStop(1,'rgba(255,255,255,0)');
        ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);

        for(const p of ps){
          p.x += p.vx; p.y += p.vy;
          if(p.x<-10) p.x=w+10; if(p.x>w+10) p.x=-10;
          if(p.y<-10) p.y=h+10; if(p.y>h+10) p.y=-10;

          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fillStyle = `rgba(0,163,255,${p.a})`; ctx.fill();

          p.a += (Math.random()-0.5)*0.02;
          p.a = Math.max(0.08, Math.min(0.6, p.a));
        }
        requestAnimationFrame(tick);
      }
      tick();
    })();

    renderGrid();
  </script>
</body>
</html>
